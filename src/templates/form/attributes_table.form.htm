<?php

?>
<div class="attributes_container">
	<input type="hidden" name="<?=$field["name_to"];?>" class="input" value="null">

	<table class="table table-bordered table-condensed">
		<thead><tr><th>Параметр</th><th>Значение</th><th></th></tr></thead>
		<tbody>
		
		</tbody>
		<tfoot>
			<tr>
				<td>
					<input class="attr_key" placeholder="Параметр">
				</td>
				<td>
					<input class="attr_value" placeholder="Значение">
				</td>
				<td><button class="btn btn-small cmdAdd"><i class="icon icon-plus"></i></button></td>
			</tr>
		</tfoot>
	</table>

	<script>
		var field_value = <?=(!empty($field["value"]) ? html_entity_decode($field["value"]) : "[]");?>;
		var tr = function(attr){
			return '<tr data-hash="'+encodeURIComponent(attr.key)+'"><td>'+attr.key+'</td><td>'+attr.value+'</td><td><a class="close cmdDel">&times;</a></td></tr>';
		};
		var render = function(){
			if (field_value instanceof Array){
				var tbody_html = $.map(field_value, function(attr){
					return tr(attr);
				}).join("");
			}else{
				
			}
			$cnt.find("table tbody").html(tbody_html);
			$input.val(JSON.stringify(field_value));
		};
		
		var $cnt = $("div.attributes_container"),
			$input = $cnt.find("input.input"),
		    $attr_key = $("input#attr_key"),
			$attr_value = $cnt.find("input.attr_value"),
			$cmdAdd = $cnt.find(".btn.cmdAdd");
		
		$cmdAdd.on("click", function(e){
			e.preventDefault();
			debugger;
			field_value.push({key: $attr_key.val(), value: $attr_value.val()});
			render();
			return false;
		});
		$cnt.on("click", ".cmdDel", function(e){
			e.preventDefault();
			debugger;
			var hash = $(this).parents("tr").data("hash");
			var i = field_value.length;
			while(i--){
				if (encodeURIComponent(field_value[i].key) == hash){
					field_value.splice(i,1);
				};
			};
			render();
			return false;
		});
		
		render();
	</script>

</div>